/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/model/BindingMode','sap/ui/model/Context','sap/ui/model/Model','sap/ui/model/odata/v2/ODataAnnotations','sap/ui/model/odata/ODataUtils','sap/ui/model/odata/CountMode','sap/ui/model/odata/UpdateMethod','sap/ui/model/odata/OperationMode','./ODataContextBinding','./ODataListBinding','sap/ui/model/odata/ODataMetadata','sap/ui/model/odata/ODataPropertyBinding','./ODataTreeBinding','sap/ui/model/odata/ODataMetaModel','sap/ui/core/message/MessageParser','sap/ui/model/odata/ODataMessageParser','sap/ui/thirdparty/datajs'],function(q,B,C,M,O,a,b,U,c,d,e,f,g,h,l,m,o,p){"use strict";var r=M.extend("sap.ui.model.odata.v2.ODataModel",{constructor:function(S,P){M.apply(this,arguments);var i,j,H,T,w,k,n,R,v,L,D,x,y,z,E,F,G,J,I,K,Q,V,W,X,Y,Z=this;if(typeof(S)==="object"){P=S;S=P.serviceUrl;}if(P){i=P.user;j=P.password;H=P.headers;T=P.tokenHandling;w=P.withCredentials;k=P.maxDataServiceVersion;n=P.useBatch;R=P.refreshAfterChange;v=P.annotationURI;L=P.loadAnnotationsJoined;x=P.defaultBindingMode;D=P.defaultCountMode;y=P.defaultOperationMode;z=P.metadataNamespaces;E=P.serviceUrlParams;F=P.metadataUrlParams;J=P.json;I=P.messageParser;K=P.skipMetadataAnnotationParsing;Q=P.defaultUpdateMethod;V=P.disableHeadRequestForToken;W=P.sequentializeRequests;X=P.disableSoftStateHeader;Y=P.bindableResponseHeaders;}this.mSupportedBindingModes={"OneWay":true,"OneTime":true,"TwoWay":true};this.sDefaultBindingMode=x||B.OneWay;this.bJSON=J!==false;this.aPendingRequestHandles=[];this.aCallAfterUpdate=[];this.mRequests={};this.mDeferredRequests={};this.mChangedEntities={};this.mChangeHandles={};this.mDeferredGroups={};this.mLaunderingState={};this.sDefaultUpdateMethod=Q||U.Merge;this.bTokenHandling=T!==false;this.bWithCredentials=w===true;this.bUseBatch=n!==false;this.bRefreshAfterChange=R!==false;this.sMaxDataServiceVersion=k;this.bLoadAnnotationsJoined=L!==false;this.sAnnotationURI=v;this.sDefaultCountMode=D||b.Request;this.sDefaultOperationMode=y||c.Server;this.sMetadataLoadEvent=null;this.oMetadataFailedEvent=null;this.sRefreshGroupId=undefined;this.bIncludeInCurrentBatch=false;this.bSkipMetadataAnnotationParsing=!!K;this.bDisableHeadRequestForToken=!!V;this.bSequentializeRequests=!!W;this.bDisableSoftStateHeader=!!X;this.aBindableResponseHeaders=Y?Y:null;if(I){I.setProcessor(this);}this.oMessageParser=I;this.sDefaultChangeGroup="changes";this.setDeferredGroups([this.sDefaultChangeGroup]);this.setChangeGroups({"*":{groupId:this.sDefaultChangeGroup}});this.oData={};this.oMetadata=null;this.oAnnotations=null;this.aUrlParams=[];this.pSequentialRequestCompleted=Promise.resolve();this.pReadyForRequest=Promise.resolve();this.sServiceUrl=S;var $=S.split("?");if($.length>1){this.sServiceUrl=$[0];if($[1]){this.aUrlParams.push($[1]);}}this.sServiceUrl=this.sServiceUrl.replace(/\/$/,"");this.sUser=i;this.sPassword=j;if(sap.ui.getCore().getConfiguration().getStatistics()){this.aUrlParams.push("sap-statistics=true");}this.oHeaders={};this.setHeaders(H);if(!this.bDisableSoftStateHeader){this.oHeaders["sap-contextid-accept"]="header";this.mCustomHeaders["sap-contextid-accept"]="header";}G=a._createUrlParamsArray(F);var _=this._createRequestUrl("/$metadata",undefined,G);this.oServiceData=r.mServiceData[_];if(!this.oServiceData){r.mServiceData[_]={};this.oServiceData=r.mServiceData[_];}if(!this.oServiceData.oMetadata||this.oServiceData.oMetadata.bFailed){this.oMetadata=new f(_,{async:true,user:this.sUser,password:this.sPassword,headers:this.mCustomHeaders,namespaces:z,withCredentials:this.bWithCredentials});this.oServiceData.oMetadata=this.oMetadata;}else{this.oMetadata=this.oServiceData.oMetadata;}this.oAnnotations=new O(this.oMetadata,{source:this.sAnnotationURI,skipMetadata:this.bSkipMetadataAnnotationParsing,headers:this.mCustomHeaders,combineEvents:true});if(!this.bDisableSoftStateHeader){delete this.mCustomHeaders["sap-contextid-accept"];}this.oAnnotations.attachAllFailed(this.onAnnotationsFailed,this);this.oAnnotations.attachSomeLoaded(this.onAnnotationsLoaded,this);this.pAnnotationsLoaded=this.oAnnotations.loaded();if(E){this.aUrlParams=this.aUrlParams.concat(a._createUrlParamsArray(E));}this.onMetadataFailed=function(a1){Z.fireMetadataFailed(a1.getParameters());};this.oMetadata.loaded().then(this._initializeMetadata.bind(this));if(!this.oMetadata.isLoaded()){this.oMetadata.attachFailed(this.onMetadataFailed);}if(this.bJSON){if(this.sMaxDataServiceVersion==="3.0"){this.oHeaders["Accept"]="application/json;odata=fullmetadata";}else{this.oHeaders["Accept"]="application/json";}}else{this.oHeaders["Accept"]="application/atom+xml,application/atomsvc+xml,application/xml";}if(this.bTokenHandling&&this.oServiceData.securityToken){this.oHeaders["x-csrf-token"]=this.oServiceData.securityToken;}this.oHeaders["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguageTag();this.oHeaders["DataServiceVersion"]="2.0";this.oHeaders["MaxDataServiceVersion"]="2.0";if(this.sMaxDataServiceVersion){this.oHeaders["MaxDataServiceVersion"]=this.sMaxDataServiceVersion;}this.oHeaders["sap-cancel-on-close"]=true;},metadata:{publicMethods:["read","create","update","remove","submitChanges","getServiceMetadata","metadataLoaded","hasPendingChanges","getPendingChanges","refresh","refreshMetadata","resetChanges","setDefaultCountMode","setDefaultBindingMode","getDefaultBindingMode","getDefaultCountMode","setProperty","getSecurityToken","refreshSecurityToken","setHeaders","getHeaders","setUseBatch","setDeferredBatchGroups","getDeferredBatchGroups","setChangeBatchGroups","getChangeBatchGroups"]}});r.M_EVENTS={MetadataLoaded:"metadataLoaded",MetadataFailed:"metadataFailed",AnnotationsLoaded:"annotationsLoaded",AnnotationsFailed:"annotationsFailed",BatchRequestFailed:"batchRequestFailed",BatchRequestSent:"batchRequestSent",BatchRequestCompleted:"batchRequestCompleted"};r.prototype.attachBatchRequestFailed=function(D,F,L){this.attachEvent("batchRequestFailed",D,F,L);return this;};r.prototype.detachBatchRequestFailed=function(F,L){this.detachEvent("batchRequestFailed",F,L);return this;};r.prototype.fireBatchRequestFailed=function(i){this.fireEvent("batchRequestFailed",i);return this;};r.prototype.attachBatchRequestSent=function(D,F,L){this.attachEvent("batchRequestSent",D,F,L);return this;};r.prototype.detachBatchRequestSent=function(F,L){this.detachEvent("batchRequestSent",F,L);return this;};r.prototype.fireBatchRequestSent=function(i){this.fireEvent("batchRequestSent",i);return this;};r.prototype.attachBatchRequestCompleted=function(D,F,L){this.attachEvent("batchRequestCompleted",D,F,L);return this;};r.prototype.detachBatchRequestCompleted=function(F,L){this.detachEvent("batchRequestCompleted",F,L);return this;};r.prototype.fireBatchRequestCompleted=function(i){this.fireEvent("batchRequestCompleted",i);return this;};r.mServiceData={};r.prototype._initializeMetadata=function(){if(this.bDestroyed){return;}var F=function(){this.fireMetadataLoaded({metadata:this.oMetadata});q.sap.log.debug(this+" - metadataloaded fired");}.bind(this);this.initialize();if(this.bLoadAnnotationsJoined){this.oAnnotations.loaded().then(F,this.fireMetadataFailed.bind(this));}else{F();}};r.prototype.refreshMetadata=function(){if(this.oMetadata&&this.oMetadata.refresh){return this.oMetadata.refresh();}};r.prototype.fireAnnotationsLoaded=function(i){this.fireEvent("annotationsLoaded",i);return this;};r.prototype.attachAnnotationsLoaded=function(D,F,L){this.attachEvent("annotationsLoaded",D,F,L);return this;};r.prototype.detachAnnotationsLoaded=function(F,L){this.detachEvent("annotationsLoaded",F,L);return this;};r.prototype.fireAnnotationsFailed=function(i){this.fireEvent("annotationsFailed",i);q.sap.log.debug(this+" - annotationsfailed fired");return this;};r.prototype.attachAnnotationsFailed=function(D,F,L){this.attachEvent("annotationsFailed",D,F,L);return this;};r.prototype.detachAnnotationsFailed=function(F,L){this.detachEvent("annotationsFailed",F,L);return this;};r.prototype.fireMetadataLoaded=function(i){this.fireEvent("metadataLoaded",i);return this;};r.prototype.attachMetadataLoaded=function(D,F,L){this.attachEvent("metadataLoaded",D,F,L);return this;};r.prototype.detachMetadataLoaded=function(F,L){this.detachEvent("metadataLoaded",F,L);return this;};r.prototype.fireMetadataFailed=function(i){this.fireEvent("metadataFailed",i);return this;};r.prototype.attachMetadataFailed=function(D,F,L){this.attachEvent("metadataFailed",D,F,L);return this;};r.prototype.detachMetadataFailed=function(F,L){this.detachEvent("metadataFailed",F,L);return this;};r.prototype._createEventInfo=function(R,k,n){var E={};E.url=R.requestUri;E.method=R.method;E.async=R.async;E.headers=R.headers;if(n){E.requests=[];for(var i=0;i<n.length;i++){var v={};if(q.isArray(n[i])){var w=n[i];for(var j=0;j<w.length;j++){var R=w[j].request;var I=n[i][j].response;v={};v.url=R.requestUri;v.method=R.method;v.headers=R.headers;if(I){v.response={};if(R._aborted){v.success=false;v.response.statusCode=0;v.response.statusText="abort";}else{v.success=true;if(I.message){v.response.message=I.message;I=I.response;v.response.responseText=I.body;v.success=false;}v.response.headers=I.headers;v.response.statusCode=I.statusCode;v.response.statusText=I.statusText;}}E.requests.push(v);}}else{var R=n[i].request;var I=n[i].response;v.url=R.requestUri;v.method=R.method;v.headers=R.headers;if(I){v.response={};if(R._aborted){v.success=false;v.response.statusCode=0;v.response.statusText="abort";}else{v.success=true;if(I.message){v.response.message=I.message;I=I.response;v.response.responseText=I.body;v.success=false;}v.response.headers=I.headers;v.response.statusCode=I.statusCode;v.response.statusText=I.statusText;}}E.requests.push(v);}}}if(k){E.response={};E.success=true;if(k.message){E.response.message=k.message;E.success=false;}if(k.response){k=k.response;}if(k&&k.statusCode!=undefined){E.response.headers=k.headers;E.response.statusCode=k.statusCode;E.response.statusText=k.statusText;E.response.responseText=k.body!==undefined?k.body:k.responseText;}}E.ID=R.requestID;return E;};r.prototype._createRequestID=function(){var R;R=q.sap.uid();return R;};r.prototype._createRequestUrl=function(P,i,j,k){var n,v=[],w="";n=this._normalizePath(P,i);if(!k){w=this.sServiceUrl+n;}else{w=n.substr(n.indexOf('/')+1);}if(this.aUrlParams){v=v.concat(this.aUrlParams);}if(j){v=v.concat(j);}if(v&&v.length>0){w+="?"+v.join("&");}return w;};r.prototype._importData=function(D,j,R){var k=this,L,K,n,E;if(D.results){L=[];q.each(D.results,function(i,y){var K=k._importData(y,j,R);if(K){L.push(K);}});return L;}else{K=this._getKey(D);if(!K){return K;}E=this._getEntity(K);if(!E){E=D;this._addEntity(E);}if(this.aBindableResponseHeaders){var H={};for(var v in R.headers){var w=v.toLowerCase();if(this.aBindableResponseHeaders.indexOf(w)>-1){H[w]=R.headers[v];}}if(!q.isEmptyObject(H)){if(!D.__metadata){D.__metadata={};}D.__metadata.headers=H;}}q.each(D,function(i,P){if(P&&(P.__metadata&&P.__metadata.uri||P.results)&&!P.__deferred){n=k._importData(P,j,R);if(q.isArray(n)){E[i]={__list:n};}else{E[i]={__ref:n};}}else if(!P||!P.__deferred){E[i]=P;}});var x={};x[K]=E;this._updateChangedEntities(x);j[K]=true;return K;}};r.prototype._removeReferences=function(D){var j=this,L;if(!D){return D;}if(D.results){L=[];q.each(D.results,function(i,k){L.push(j._removeReferences(k));});return L;}else{q.each(D,function(P,i){if(i){if(i["__ref"]||i["__list"]){delete D[P];}}});return D;}};r.prototype._restoreReferences=function(D,v){var j=this,k,n,R;function w(k){var n=v[k];if(!n){n=j._getObject("/"+k);if(n){n=q.sap.extend(true,{},n);v[k]=n;j._restoreReferences(n,v);}}return n;}if(!v){v={};}q.each(D,function(P,x){if(x){if(x.__ref){k=x.__ref;n=w(k);if(n){D[P]=n;}delete x.__ref;}else if(x.__list){R=[];q.each(x.__list,function(i,k){n=w(k);if(n){R.push(n);}});delete x.__list;x.results=R;}}});return D;};r.prototype.removeData=function(){this.oData={};};r.prototype.initialize=function(){var i=this.aBindings.slice(0);q.each(i,function(I,j){j.initialize();});};r.prototype.refresh=function(F,R,G){if(typeof F==="string"){G=F;F=false;R=false;}if(R){this.removeData();}this._refresh(F,G);};r.prototype._refresh=function(F,G,i,E){var j=this.aBindings.slice(0);this.sRefreshGroupId=G;q.each(j,function(I,k){k._refresh(F,i,E);});this.sRefreshGroupId=undefined;};r.prototype.checkUpdate=function(F,i,j,k){if(i){if(!this.sUpdateTimer){this.sUpdateTimer=q.sap.delayedCall(0,this,function(){this.checkUpdate(F,false,j);});}return;}if(this.sUpdateTimer){q.sap.clearDelayedCall(this.sUpdateTimer);this.sUpdateTimer=null;}var n=this.aBindings.slice(0);q.each(n,function(I,v){if(!k||this.isMetaModelPath(v.getPath())){v.checkUpdate(F,j);}}.bind(this));this._processAfterUpdate();};r.prototype.checkDataState=function(L){var i=this.aBindings.slice(0);q.each(i,function(I,j){if(j.checkDataState){j.checkDataState(L);}});};r.prototype.bindProperty=function(P,i,j){var k=new g(this,P,i,j);return k;};r.prototype.bindList=function(P,i,S,F,j){var k=new e(this,P,i,S,F,j);return k;};r.prototype.bindTree=function(P,i,F,j,S){var k=new h(this,P,i,F,j,S);return k;};r.prototype.createBindingContext=function(P,i,j,k,R){var n=this.resolve(P,i),v,w,G,x=this;if(typeof i=="function"){R=j;k=i;j=undefined;i=undefined;}if(typeof j=="function"){R=k;k=j;j=undefined;}if(!n){if(k){k(null);}return null;}if(R===undefined){R=this._isReloadNeeded(n,j);}if(!R){v=this.resolve(P,i,true);w=this.getContext(v);if(k){k(w);}return w;}function y(F){var K=F?x._getKey(F):null,H=null,J,L;w=null;if(K){w=x.getContext('/'+K);H={__ref:K};}if(i&&I){J=i.getPath();J=J.substr(1);L=x._getEntity(J);if(L){L[P]=H;}}k(w);}function z(F){var H;if(F.statusCode=='404'&&i&&I){var J=i.getPath();J=J.substr(1);H=x._getEntity(J);if(H){H[P]={__ref:null};}}k(null);}if(k){var I=!q.sap.startsWith(P,"/");if(n){var D=[],E=this.createCustomParams(j);if(E){D.push(E);}if(j&&(j.batchGroupId||j.groupId)){G=j.groupId||j.batchGroupId;}this.read(n,{groupId:G,urlParameters:D,success:y,error:z});}else{k(null);}}};r.prototype._splitEntries=function(E){return E.replace(/\s/g,"").split(',').map(function(i){return i.split("/");});};r.prototype._filterOwnSelect=function(S,E){var i,j;if(!E){return[];}j=E.map(function(P){return P.name;});i=S.filter(function(k){return k.length===1;}).map(function(k){return k[0];});if(S.length===0||i.indexOf("*")!==-1||i.indexOf("**")!==-1){return j;}else{return i.filter(function(k){return j.indexOf(k)!==-1;});}};r.prototype._filterOwnExpand=function(E,S){return E.map(function(i){return i[0];}).filter(function(v,i,j){return j.indexOf(v)===i;}).filter(function(v){return S.length===0||S.some(function(i){return i.indexOf(v)===0||i.indexOf("**")===0;});});};r.prototype._filterSelectByNavProp=function(E,n){return E.filter(function(S){return S[0]===n;}).map(function(S){return S.length>1?S.slice(1):["**"];});};r.prototype._filterExpandByNavProp=function(E,n){return E.filter(function(S){return S.length>1&&S[0]===n;}).map(function(S){return S.slice(1);});};r.prototype._isReloadNeeded=function(P,k){var n=this,v=this.oMetadata,E=this.oMetadata._getEntityTypeByPath(P),w=this._getObject(P),x=[],S=[];if(this._isCreatedEntity(w)){return false;}function y(E,w,S,x){var z,D,F,G,H,I,J,K,L;if(!E){return false;}if(w===null){return false;}if(!w){return true;}z=n._filterOwnSelect(S,E.property);for(var i=0;i<z.length;i++){L=z[i];if(w[L]===undefined){return true;}}D=n._filterOwnExpand(x,S);for(var i=0;i<D.length;i++){K=D[i];F=w[K];if(F===null){continue;}if(F===undefined||F.__deferred){return true;}G=v._getEntityTypeByNavProperty(E,K);I=n._filterSelectByNavProp(S,K);J=n._filterExpandByNavProp(x,K);if(F.__ref){H=n._getEntity(F.__ref);if(y(G,H,I,J)){return true;}}if(F.__list){for(var j=0;j<F.__list.length;j++){H=n._getEntity(F.__list[j]);if(y(G,H,I,J)){return true;}}}}return false;}if(k){if(k.select){S=this._splitEntries(k.select);}if(k.expand){x=this._splitEntries(k.expand);}}return y(E,w,S,x);};r.prototype.createCustomParams=function(P){var i=[],j,S={expand:true,select:true};for(var n in P){if(n in S){i.push("$"+n+"="+q.sap.encodeURL(P[n]));}if(n==="custom"){j=P[n];for(n in j){if(n.indexOf("$")===0){q.sap.log.warning(this+" - Trying to set OData parameter '"+n+"' as custom query option!");}else if(j[n]===undefined){i.push(n);}else{i.push(n+"="+q.sap.encodeURL(j[n]));}}}}return i.join("&");};r.prototype.bindContext=function(P,i,j){var k=new d(this,P,i,j);return k;};r.prototype.setDefaultCountMode=function(i){this.sDefaultCountMode=i;};r.prototype.getDefaultCountMode=function(){return this.sDefaultCountMode;};r.prototype._addEntity=function(E){var k=this._getKey(E);this.oData[k]=E;};r.prototype._removeEntity=function(k){k=k&&this._normalizeKey(k);delete this.oData[k];delete this.mChangedEntities[k];delete this.mContexts["/"+k];};r.prototype._getEntity=function(k){k=k&&this._normalizeKey(k);return this.oData[k];};r.prototype._getKey=function(v){var k,i;if(v instanceof C){k=v.getPath().substr(1);}else if(v&&v.__metadata&&v.__metadata.uri){i=v.__metadata.uri;k=i.substr(i.lastIndexOf("/")+1);}else if(typeof v==='string'){k=v.substr(v.lastIndexOf("/")+1);}return k&&this._normalizeKey(k);};r.prototype.getKey=function(v){return this._getKey(v);};r.prototype.createKey=function(j,k){var E=this.oMetadata._getEntityTypeByPath(j),K=j,n=this,v,P;K+="(";if(E.key.propertyRef.length===1){v=E.key.propertyRef[0].name;P=this.oMetadata._getPropertyMetadata(E,v);K+=encodeURIComponent(a.formatValue(k[v],P.type));}else{q.each(E.key.propertyRef,function(i,w){if(i>0){K+=",";}v=w.name;P=n.oMetadata._getPropertyMetadata(E,v);K+=v;K+="=";K+=encodeURIComponent(a.formatValue(k[v],P.type));});}K+=")";return K;};var s=/([(=,])('.*?')([,)])/g,t=/[MLDF](?=[,)](?:[^']*'[^']*')*[^']*$)/g,N=function(v,i,j,k){return i+encodeURIComponent(decodeURIComponent(j))+k;},u=function(v){return v.toLowerCase();};r.prototype._normalizeKey=function(k){return k.replace(s,N).replace(t,u);};r.prototype.getProperty=function(P,i,I){var v=this._getObject(P,i);if(!I){return v;}if(!q.isPlainObject(v)){return v;}v=q.sap.extend(true,{},v);if(I===true){return this._restoreReferences(v);}else{return this._removeReferences(v);}};r.prototype.getObject=function(P,n,v){if(q.isPlainObject(n)){v=n;n=undefined;}var w=this,R=this.resolve(P,n),V=this._getObject(R),E=this.oMetadata._getEntityTypeByPath(R),x=[],S=[];if(!E||!q.isPlainObject(V)||!V.__metadata||!V.__metadata.uri){return V;}if(!v||!(v.select||v.expand)){return q.sap.extend(true,{},V);}function y(E,V,S,x){var z,D,F,G,H,I,J,K,L,Q,T,W,X;if(!V){return undefined;}if(!E){return undefined;}F=w._filterOwnSelect(S,E.property);D={};for(var i=0;i<F.length;i++){W=F[i];if(V[W]!==undefined){D[W]=V[W];}else{q.sap.log.fatal("No data loaded for select property: "+W+" of entry: "+w.getKey(V));return undefined;}}if(V.__metadata){D.__metadata=V.__metadata;}z=w._filterOwnExpand(x,S);for(var i=0;i<z.length;i++){T=z[i];H=V[T];I=w.oMetadata._getEntityTypeByNavProperty(E,T);L=w._filterSelectByNavProp(S,T);Q=w._filterExpandByNavProp(x,T);if(H&&H.__ref){K=w._getObject("/"+H.__ref);J=y(I,K,L,Q);if(J!==undefined){D[T]=J;}else{q.sap.log.fatal("No data loaded for expand property: "+T+" of entry: "+w.getKey(J));return undefined;}}if(H&&H.__list){X=[];for(var j=0;j<H.__list.length;j++){K=w._getObject("/"+H.__list[j]);J=y(I,K,L,Q);if(J!==undefined){X.push(J);}else{q.sap.log.fatal("No data loaded for expand property: "+T+" of entry: "+w.getKey(J));return undefined;}}D[T]=X;}}G=w._filterOwnSelect(S,E.navigationProperty);for(var k=0;k<G.length;k++){T=G[k];if(z.indexOf(T)===-1){var Y=D.__metadata.uri+"/"+T;D[T]={__deferred:{uri:Y}};}}return D;}if(v.select){S=this._splitEntries(v.select);}if(v.expand){x=this._splitEntries(v.expand);}V=y(E,V,S,x);return V;};r.prototype._getObject=function(P,i,j){var n=this.isLegacySyntax()?this.oData:null,k,v,R=this.resolve(P,i),S,D,w,x,K,y;if(this.oMetadata&&this.oMetadata.isLoaded()&&R&&R.indexOf('/#')>-1){if(this.isMetaModelPath(R)){S=R.indexOf('/##');y=this.getMetaModel();if(!this.bMetaModelLoaded){return null;}D=R.substr(0,S);w=R.substr(S+3);x=y.getMetaContext(D);n=y.getProperty(w,x);}else{n=this.oMetadata._getAnnotation(R);}}else{if(!R){return n;}if(R==="/"){return this.oData;}var z=R.split("/"),I=0;K=z[1];z.splice(0,2);k=this.mChangedEntities[K];v=this._getEntity(K);n=j?v:k||v;while(n&&z[I]){var H=k&&k.hasOwnProperty(z[I]);k=k&&k[z[I]];v=v&&v[z[I]];n=j||!H?v:k;if(n){if(n.__ref){k=this.mChangedEntities[n.__ref];v=this._getEntity(n.__ref);n=j?v:k||v;}else if(n.__list){n=n.__list;}else if(n.__deferred){n=undefined;}}I++;}}if(q.isPlainObject(k)){n=j?v:q.sap.extend(true,{},v,k);}return n;};r.prototype.updateSecurityToken=function(){if(this.bTokenHandling){if(!this.oServiceData.securityToken){this.refreshSecurityToken();}if(this.bTokenHandling){this.oHeaders["x-csrf-token"]=this.oServiceData.securityToken;}}};r.prototype.resetSecurityToken=function(){delete this.oServiceData.securityToken;delete this.oHeaders["x-csrf-token"];delete this.pSecurityToken;};r.prototype.getSecurityToken=function(){var T=this.oServiceData.securityToken;if(!T){this.refreshSecurityToken();T=this.oServiceData.securityToken;}return T;};r.prototype.securityTokenAvailable=function(){if(!this.pSecurityToken){if(this.oServiceData.securityToken){this.pSecurityToken=Promise.resolve(this.oServiceData.securityToken);}else{this.pSecurityToken=new Promise(function(i,j){this.refreshSecurityToken(function(){i(this.oServiceData.securityToken);}.bind(this),function(){j();},true);}.bind(this));}}return this.pSecurityToken;};r.prototype.refreshSecurityToken=function(S,E,i){var T;var j=this;var k=this._createRequestUrl("/");var n={abort:function(){this.request.abort();}};function v(D,R){if(R){T=j._getHeader("x-csrf-token",R.headers);j._setSessionContextIdHeader(j._getHeader("sap-contextid",R.headers));if(T){j.oServiceData.securityToken=T;j.pSecurityToken=Promise.resolve(T);j.oHeaders["x-csrf-token"]=T;}else{j.resetSecurityToken();j.bTokenHandling=false;}}if(S){S(D,R);}}function w(z){j.resetSecurityToken();j.bTokenHandling=false;j._handleError(z);if(E){E(z);}}function x(z){n.request=y("GET",w);}function y(R,E){var z=j._createRequest(k,R,j._getHeaders(),null,null,!!i);z.headers["x-csrf-token"]="Fetch";return j._request(z,v,E,undefined,undefined,j.getServiceMetadata());}if(this.bDisableHeadRequestForToken){n.request=y("GET",w);}else{n.request=y("HEAD",x);}return n;};r.prototype._submitRequest=function(R,S,E){var j=this,H,k,n,v,w;v=new Promise(function(i,I){w=i;});function x(i,I){if(S){S(i,I);}w();}function y(i){if(j.bTokenHandling&&i.response){var T=j._getHeader("x-csrf-token",i.response.headers);if(!R.bTokenReset&&i.response.statusCode=='403'&&T&&T.toLowerCase()==="required"){j.resetSecurityToken();R.bTokenReset=true;D();return;}}if(E){E(i);}w();}function z(R){if(j.bTokenHandling&&R.method!=="GET"){j.pReadyForRequest=j.securityTokenAvailable();}return j.pReadyForRequest;}function D(){z(R).then(function(T){if(j.bTokenHandling&&R.method!=="GET"){R.headers["x-csrf-token"]=T;}G();},function(){G();});}function F(T,R,I){var J,K=R.eventInfo.requests;if(K){q.each(K,function(i,R){if(q.isArray(R)){q.each(R,function(i,R){q.each(R.parts,function(i,P){J=j._createEventInfo(R.request,P.fnError);j["fireRequest"+T](J);});});}else{if(R.parts){q.each(R.parts,function(i,P){J=j._createEventInfo(R.request,P.fnError);j["fireRequest"+T](J);});}else{J=j._createEventInfo(R.request,R.fnError);j["fireRequest"+T](J);}}});if(R.eventInfo.batch){J=j._createEventInfo(R,I,K);j["fireBatchRequest"+T](J);}}}function G(){if(j.sSessionContextId){R.headers["sap-contextid"]=j.sSessionContextId;}k=j._request(R,x,y,H,undefined,j.getServiceMetadata());if(R.eventInfo){F("Sent",R,null);delete R.eventInfo;}if(n){k.abort();}}H=j._getODataHandler(R.requestUri);if(this.bSequentializeRequests){this.pSequentialRequestCompleted.then(function(){D();});this.pSequentialRequestCompleted=v;}else{D();}return{abort:function(){if(k){k.abort();}n=true;}};};r.prototype._setSessionContextIdHeader=function(S){if(S){this.sSessionContextId=S;}};r.prototype._submitSingleRequest=function(R){var j=this,k,n={},G={},E={};function v(D,x){if(D===undefined&&x.statusCode===200){w({message:"Response did not contain a valid OData result",response:x});return;}function y(D,x){for(var i=0;i<R.parts.length;i++){if(R.parts[i].request._aborted){j._processAborted(R.parts[i].request,x);}else if(R.parts[i].fnSuccess){R.parts[i].fnSuccess(D,x);}}if(R.request.requestUri.indexOf("$count")===-1){j.checkUpdate(false,false,G);if(R.bRefreshAfterChange){j._refresh(false,undefined,n,E);}}}j._processSuccess(R.request,x,y,G,n,E);j._setSessionContextIdHeader(j._getHeader("sap-contextid",x.headers));}function w(x){if(x.message=="Request aborted"){for(var i=0;i<R.parts.length;i++){j._processAborted(R.parts[i].request,x);}}else{for(var i=0;i<R.parts.length;i++){j._processError(R.parts[i].request,x,R.parts[i].fnError);}}j._processAfterUpdate();}R.request.eventInfo={requests:R.parts,batch:false};k=this._submitRequest(R.request,v,w);return k;};r.prototype._submitBatchRequest=function(k,R,S,E){var n=this,v={},G={},w={};function x(j,I,J){for(var i=0;i<j.parts.length;i++){if(J||j.parts[i].request._aborted){n._processAborted(j.parts[i].request,I);}else if(I.message){n._processError(j.parts[i].request,I,j.parts[i].fnError);}else{n._processSuccess(j.parts[i].request,I,j.parts[i].fnSuccess,G,v,w);}}}function y(I,J){if(I===undefined&&J.statusCode===200){z({message:"Response did not contain a valid OData batch result",response:J});return;}var K,L,P,Q=I.__batchResponses;if(Q){var i,j;for(i=0;i<Q.length;i++){K=Q[i];if(q.isArray(R[i])){if(K.message){for(j=0;j<R[i].length;j++){L=R[i][j];x(L,K);L.response=K;}}else{P=K.__changeResponses;for(j=0;j<P.length;j++){var T=P[j];L=R[i][j];x(L,T);L.response=T;}}}else{L=R[i];x(L,K);L.response=K;}}n.checkUpdate(false,false,G);}n._processSuccess(k,J,S,G,v,w,true,R);n._setSessionContextIdHeader(n._getHeader("sap-contextid",J.headers));}function z(j){var I=j.message=="Request aborted";q.each(R,function(i,J){if(q.isArray(J)){q.each(J,function(i,J){x(J,j,I);});}else{x(J,j,I);}});n._processAfterUpdate();if(I){n._processAborted(k,j,true);}else{n._processError(k,j,E,true,R);}}k.eventInfo={requests:R,batch:true};var D=this._submitRequest(k,y,z);function F(j){var E;for(var i=0;i<j.parts.length;i++){E=j.parts[i].fnError;if(!j.parts[i].request._aborted&&E){E(A);}}}var H={abort:function(){q.each(R,function(i,j){if(Array.isArray(j)){j.forEach(function(j){F(j);});}else{F(j);}});D.abort();}};return H;};r.prototype._createBatchRequest=function(i){var j,R,k={},P={};P.__batchRequests=i;j=this.sServiceUrl+"/$batch";if(this.aUrlParams.length>0){j+="?"+this.aUrlParams.join("&");}q.extend(k,this.mCustomHeaders,this.oHeaders);k["Accept"]="multipart/mixed";delete k["Content-Type"];R={headers:k,requestUri:j,method:"POST",data:P,user:this.sUser,password:this.sPassword,async:true};R.withCredentials=this.bWithCredentials;return R;};r.prototype.abortInternalRequest=function(k,G){var R=this.mRequests;if(G in this.mDeferredGroups){R=this.mDeferredRequests;}var j=R[G];if(j&&k in j.map){var n=j.map[k];for(var i=0;i<n.parts.length;i++){n.parts[i].requestHandle.abort();}}};r.prototype._pushToRequestQueue=function(R,G,i,j,S,E,k,n){var v=R[G],w=j.key?j.key:j.method+":"+j.requestUri;if(!v){v={};v.map={};v.requests=[];R[G]=v;}if(w in v.map&&(j.key||j.method==='GET')){var x=v.map[w];var y=x.request;if(x.bRefreshAfterChange===undefined){x.bRefreshAfterChange=n;}if(!j.key){x.parts.push({request:j,fnSuccess:S,fnError:E,requestHandle:k});}if(j.method==="GET"){delete y.data;}else{y.method=j.method;y.headers=j.headers;y.data=j.data;y.requestUri=j.requestUri;if(j.method==="PUT"){delete y.headers["x-http-method"];}if(y._aborted){delete y._aborted;}}}else{var x={request:j,bRefreshAfterChange:n,parts:[{request:j,fnSuccess:S,fnError:E,requestHandle:k}]};if(j.method==="GET"){v.requests.push(x);}else{if(!v.changes){v.changes={};}var z=v.changes[i];if(!z){z=[];v.changes[i]=z;}x.changeSetId=i;z.push(x);}v.map[w]=x;}};r.prototype._collectChangedEntities=function(G,j,E){var k=this;if(G.changes){q.each(G.changes,function(n,v){for(var i=0;i<v.length;i++){if(v[i].bRefreshAfterChange){var R=v[i].request,P="/"+R.requestUri.split("?")[0],w,K;if(R.method==="POST"||R.method==="DELETE"){var x=k.oMetadata._getEntityTypeByPath(P);if(x){E[x.entityType]=true;}}else{w=k._getObject(P);if(w){K=k._getKey(w);}else if(P.lastIndexOf("/")===0){K=k._getKey(P);}if(K){j[K]=true;}}}}});}};r.prototype._processRequestQueue=function(R,G,S,E){var j=this,P,k=[];function n(v,W){for(var i=0;i<v.parts.length;i++){var x=v.parts[i];if(x.request._aborted){j._processAborted(v.request,null);v.parts.splice(i,1);i--;}else if(W){x.request._handle=W;W.iRelevantRequests++;}}}function w(){return{iRelevantRequests:0,oRequestHandle:{},abort:function(){this.iRelevantRequests--;if(this.iRelevantRequests===0&&this.oRequestHandle){this.oRequestHandle.abort();}}};}if(this.bUseBatch){q.each(R,function(i,v){if(i===G||!G){var x={},y={};j._collectChangedEntities(v,x,y);if(Object.keys(x).length||Object.keys(y).length){j.bIncludeInCurrentBatch=true;j._refresh(false,i,x,y);j.bIncludeInCurrentBatch=false;}}});q.each(R,function(v,x){if(v===G||!G){var y=[],z=[],D,F;var W=w();if(x.changes){q.each(x.changes,function(J,K){D={__changeRequests:[]};F=[];for(var i=0;i<K.length;i++){P='/'+j.getKey(K[i].request.data);j.increaseLaundering(P,K[i].request.data);n(K[i],W);if(K[i].parts.length>0){if(K[i].request.data&&K[i].request.data.__metadata){delete K[i].request.data.__metadata.created;}D.__changeRequests.push(K[i].request);F.push(K[i]);}}if(D.__changeRequests&&D.__changeRequests.length>0){y.push(D);z.push(F);}});}if(x.requests){var H=x.requests;for(var i=0;i<H.length;i++){n(H[i],W);if(H[i].parts.length>0){y.push(H[i].request);z.push(H[i]);}}}if(y.length>0){var I=j._createBatchRequest(y,true);W.oRequestHandle=j._submitBatchRequest(I,z,S,E);k.push(W.oRequestHandle);}delete R[v];}});}else{q.each(R,function(v,x){if(v===G||!G){if(x.changes){q.each(x.changes,function(z,D){for(var i=0;i<D.length;i++){var W=w();P='/'+j.getKey(D[i].request.data);j.increaseLaundering(P,D[i].request.data);n(D[i],W);if(D[i].parts.length>0){W.oRequestHandle=j._submitSingleRequest(D[i]);k.push(W.oRequestHandle);}}});}if(x.requests){var y=x.requests;for(var i=0;i<y.length;i++){var W=w();n(y[i],W);if(y[i].parts.length>0){W.oRequestHandle=j._submitSingleRequest(y[i]);k.push(W.oRequestHandle);}}}delete R[v];}});}this.checkDataState(this.mLaunderingState);return k.length==1?k[0]:k;};r.prototype._processRequestQueueAsync=function(R){var i=this;if(!this.pCallAsnyc){this.pCallAsnyc=Promise.resolve();this.pCallAsnyc.then(function(){i._processRequestQueue(R);i.pCallAsnyc=undefined;});}};r.prototype._processSuccess=function(R,i,S,G,j,E,k,n){var v=i.data,I,w,x,P,y,z,D,L={},F={},H=this;if(!k){w=!(i.statusCode===204||i.statusCode==='204');x=R.requestUri;P=x.replace(this.sServiceUrl,"");if(!q.sap.startsWith(P,'/')){P='/'+P;}P=this._normalizePath(P);this.decreaseLaundering(P,R.data);if(w&&v===undefined&&i){this._parseResponse(i,R);q.sap.log.fatal(this+" - No data was retrieved by service: '"+i.requestUri+"'");H.fireRequestCompleted({url:i.requestUri,type:"GET",async:i.async,info:"Accept headers:"+this.oHeaders["Accept"],infoObject:{acceptHeaders:this.oHeaders["Accept"]},success:false});return false;}if(v&&v.results&&!q.isArray(v.results)){v=v.results;}if(!i._imported&&v&&(q.isArray(v)||typeof v=='object')){I=q.sap.extend(true,{},v);H._importData(I,L,i);i._imported=true;}z=this._getEntity(R.key);if(L&&z&&z.__metadata.created&&z.__metadata.created.functionImport){var J=[];var K=z["$result"];if(K&&K.__list){q.each(L,function(T){J.push(T);});K.__list=J;}else if(K&&K.__ref){q.each(L,function(T){K.__ref=T;});}}if(!w){y=P.split("/");if(y[1]){F[y[1]]=R;var Q={};Q[y[1]]=R.data;this._updateChangedEntities(Q);}if(R.method==="DELETE"&&y[2]!=="$links"){this._removeEntity(y[1]);}}if(w&&R.method==="POST"){D=this.oMetadata._getEntityTypeByPath(P);if(D){E[D.entityType]=true;}if(R.key){var T=this._getKey(v);var V=this.getContext("/"+R.key);V.sPath='/'+T;V.bCreated=false;this.mContexts[T]=V;this._removeEntity(R.key);z=this._getEntity(T);if(z){delete z.__metadata.created;}}}this._parseResponse(i,R,L,F);q.extend(G,L);q.extend(j,F);this._updateETag(R,i);}if(S){S(v,i);}var W=this._createEventInfo(R,i,n);if(k){this.fireBatchRequestCompleted(W);}else{this.fireRequestCompleted(W);}return true;};r.prototype._processError=function(R,i,E,j,k){var P,n=this._handleError(i,R);if(!j){P='/'+this.getKey(R.data);this.decreaseLaundering(P,R.data);}if(E){E(n);}var v=this._createEventInfo(R,n,k);if(j){this.fireBatchRequestCompleted(v);this.fireBatchRequestFailed(v);}else{this.fireRequestCompleted(v);this.fireRequestFailed(v);}};var A={message:"Request aborted",statusCode:0,statusText:"abort",headers:{},responseText:""};r.prototype._processAborted=function(R,i,j){var P;if(!j){P='/'+this.getKey(R.data);this.decreaseLaundering(P,R.data);}if(i){var E=this._createEventInfo(R,A);E.success=false;if(j){this.fireBatchRequestCompleted(E);}else{this.fireRequestCompleted(E);}}};r.prototype._processAfterUpdate=function(){var j=this.aCallAfterUpdate;this.aCallAfterUpdate=[];for(var i=0;i<j.length;i++){j[i]();}};r.prototype._processChange=function(k,D,i){var P,E,j,v,w,x,H,y,R,z,F=this;E=this.oMetadata._getEntityTypeByPath(k);if(!i){i="MERGE";}P=q.sap.extend(true,{},this._getObject('/'+k,true),D);if(D.__metadata&&D.__metadata.created){v=D.__metadata.created.method?D.__metadata.created.method:"POST";k=D.__metadata.created.key;j=D.__metadata.created;if(D.__metadata.created.functionImport){j.urlParameters=this._createFunctionImportParameters(D.__metadata.created.key,v,P);P=undefined;}}else if(i==="MERGE"){v="MERGE";z=this._getEntity(k);}else{v="PUT";}if(P&&P.__metadata){for(var n in P.__metadata){if(n!=='type'&&n!=='uri'&&n!=='etag'&&n!=='content_type'&&n!=='media_src'){delete P.__metadata[n];}}}if(P&&E){var G=this.oMetadata._getNavigationPropertyNames(E);q.each(G,function(K,L){delete P[L];});}if(v==="MERGE"&&E&&z){q.each(P,function(K,L){if(K!=='__metadata'){if(q.sap.equal(z[K],L)&&!F.isLaundering('/'+k+'/'+K)){delete P[K];}}});var I="/"+k,J;q.each(P,function(K,L){if(K!=='__metadata'){J=F.getProperty(I+"/"+K+"/#@sap:unit");if(J){if(P[J]===undefined){P[J]=z[J];}}}});}P=this._removeReferences(P);y=j&&j.urlParameters?a._createUrlParamsArray(j.urlParameters):undefined;H=j&&j.headers?this._getHeaders(j.headers):this._getHeaders();w=j&&j.eTag?j.eTag:this.getETag(P);x=this._createRequestUrl('/'+k,null,y,this.bUseBatch);R=this._createRequest(x,v,H,P,w);if(this.bUseBatch){R.requestUri=R.requestUri.replace(this.sServiceUrl+'/','');}return R;};r.prototype._resolveGroup=function(k){var i,E,P,G,j,D;E=this.oMetadata._getEntityTypeByPath(k);D=this._getObject('/'+k);if(D){P=D.__metadata.created;if(P){return{groupId:P.groupId,changeSetId:P.changeSetId};}}if(this.mChangeGroups[E.name]){i=this.mChangeGroups[E.name];G=i.groupId;j=i.single?q.sap.uid():i.changeSetId;}else if(this.mChangeGroups['*']){i=this.mChangeGroups['*'];G=i.groupId;j=i.single?q.sap.uid():i.changeSetId;}return{groupId:G,changeSetId:j};};r.prototype._updateETag=function(R,i){var j,E,k;j=R.requestUri.replace(this.sServiceUrl+'/','');if(!q.sap.startsWith(j,"/")){j="/"+j;}E=this._getObject(j.split("?")[0]);k=this._getHeader("etag",i.headers);if(E&&E.__metadata&&k){E.__metadata.etag=k;}};r.prototype._handleError=function(E,R){var P={},T;var i="The following problem occurred: "+E.message;P.message=E.message;if(E.response){this._parseResponse(E.response,R);if(this.bTokenHandling){T=this._getHeader("x-csrf-token",E.response.headers);if(E.response.statusCode=='403'&&T&&T.toLowerCase()==="required"){this.resetSecurityToken();}}i+=E.response.statusCode+","+E.response.statusText+","+E.response.body;P.statusCode=E.response.statusCode;P.statusText=E.response.statusText;P.headers=E.response.headers;P.responseText=E.response.body;}q.sap.log.fatal(i);return P;};r.prototype.getData=function(P,i,I){return this.getProperty(P,i,I);};r.prototype._getODataHandler=function(i){if(i.indexOf("$batch")>-1){return p.batchHandler;}else if(i.indexOf("$count")>-1){return undefined;}else if(this.bJSON){return p.jsonHandler;}else{return p.atomHandler;}};r.prototype.getETag=function(P,i,E){if(typeof P=="object"){E=P;P="";}return this._getETag(P,i,E);};r.prototype._getETag=function(P,i,D){if(!D||!D.__metadata){D=this._getObject(P,i);}if(D&&D.__metadata){return D.__metadata.etag;}return null;};r.prototype.forceEntityUpdate=function(k){var D=this.mChangedEntities[k];if(D&&D.__metadata){D.__metadata.etag='*';}else{q.sap.log.error(this+" - Entity with key "+k+" does not exist or has no change");}};r.prototype._createRequest=function(i,j,H,D,E,k){k=k!==false;if(E&&j!=="GET"){H["If-Match"]=E;}if(!H["Content-Type"]&&j!=="DELETE"&&j!=="GET"){if(this.bJSON){H["Content-Type"]="application/json";}else{H["Content-Type"]="application/atom+xml";}}if(i.indexOf("$count")>-1){H["Accept"]="text/plain, */*;q=0.5";}if(j==="MERGE"&&!this.bUseBatch){H["x-http-method"]="MERGE";j="POST";}var R={headers:H,requestUri:i,method:j,user:this.sUser,password:this.sPassword,async:k};if(D){R.data=D;}if(this.bWithCredentials){R.withCredentials=this.bWithCredentials;}R.requestID=this._createRequestID();return R;};r.prototype._processRequest=function(P,E){var R,i,j=false,k=this;R={abort:function(){if(!j&&E){E(A);}if(i){i._aborted=true;if(i._handle){i._handle.abort();}}j=true;}};this.oMetadata.loaded().then(function(){i=P(R);k._processRequestQueueAsync(k.mRequests);if(j){R.abort();}});return R;};r.prototype.update=function(P,D,i){var S,E,R,j,k,n,v,G,w,x,H,y,z,F,I=this;if(i){G=i.groupId||i.batchGroupId;w=i.changeSetId;k=i.context;S=i.success;E=i.error;n=i.eTag;H=i.headers;x=i.urlParameters;F=i.refreshAfterChange;if(i.merge!==undefined){y=i.merge?"MERGE":"PUT";}}F=this._getRefreshAfterChange(F,G);v=a._createUrlParamsArray(x);H=this._getHeaders(H);y=y?y:this.sDefaultUpdateMethod;n=n||this._getETag(P,k,D);return this._processRequest(function(J){j=I._createRequestUrl(P,k,v,I.bUseBatch);R=I._createRequest(j,y,H,D,n);z=I.mRequests;if(G in I.mDeferredGroups){z=I.mDeferredRequests;}I._pushToRequestQueue(z,G,w,R,S,E,J,F);return R;},E);};r.prototype.create=function(P,D,i){var R,j,E,k,S,n,v,w,H,x,y,G,z,F,I,J=this;if(i){k=i.context;v=i.urlParameters;S=i.success;n=i.error;G=i.groupId||i.batchGroupId;F=i.changeSetId;y=i.eTag;H=i.headers;I=i.refreshAfterChange;}I=this._getRefreshAfterChange(I,G);x=a._createUrlParamsArray(v);H=this._getHeaders(H);z="POST";return this._processRequest(function(K){j=J._createRequestUrl(P,k,x,J.bUseBatch);R=J._createRequest(j,z,H,D,y);P=J._normalizePath(P,k);E=J.oMetadata._getEntityTypeByPath(P);R.entityTypes={};if(E){R.entityTypes[E.entityType]=true;}w=J.mRequests;if(G in J.mDeferredGroups){w=J.mDeferredRequests;}J._pushToRequestQueue(w,G,F,R,S,n,K,I);return R;},n);};r.prototype.remove=function(P,i){var j,k,S,E,R,n,G,v,w,x,y,H,z,D,F,I=this;if(i){G=i.groupId||i.batchGroupId;v=i.changeSetId;j=i.context;S=i.success;E=i.error;w=i.eTag;H=i.headers;y=i.urlParameters;x=i.refreshAfterChange;}x=this._getRefreshAfterChange(x,G);z=a._createUrlParamsArray(y);H=this._getHeaders(H);D="DELETE";w=w||this._getETag(P,j);function J(K,L){k=n.substr(n.lastIndexOf('/')+1);if(k.indexOf('?')!==-1){k=k.substr(0,k.indexOf('?'));}I._removeEntity(k);if(S){S(K,L);}}return this._processRequest(function(K){n=I._createRequestUrl(P,j,z,I.bUseBatch);R=I._createRequest(n,D,H,undefined,w);F=I.mRequests;if(G in I.mDeferredGroups){F=I.mDeferredRequests;}I._pushToRequestQueue(F,G,v,R,J,E,K,x);return R;},E);};r.prototype.callFunction=function(F,P){var R,i,j,k,n,v,S,E,w="GET",G,x,H,y,z=this,K,D,I,J,L,Q,T,V={};if(P){G=P.groupId||P.batchGroupId;x=P.changeSetId;w=P.method?P.method:w;n=q.extend({},P.urlParameters);y=P.eTag;S=P.success;E=P.error;H=P.headers;T=P.refreshAfterChange;}T=this._getRefreshAfterChange(T,G);if(!q.sap.startsWith(F,"/")){q.sap.log.fatal(this+" callFunction: path '"+F+"' must be absolute!");return;}H=this._getHeaders(H);L=new Promise(function(W,X){I=W;J=X;});Q=this._processRequest(function(W){j=z.oMetadata._getFunctionImportMetadata(F,w);if(!j){J();return;}var X=j.entitySet||j.entitySetPath;if(X){V.$result={__list:[]};if(j.returnType&&j.returnType.indexOf("Collection")==-1){V.$result={__ref:{}};}}if(j.parameter!=null){q.each(j.parameter,function(Y,Z){V[Z.name]=z._createPropertyValue(Z.type);if(n&&n[Z.name]!==undefined){V[Z.name]=n[Z.name];n[Z.name]=a.formatValue(n[Z.name],Z.type);}else{q.sap.log.warning(z+" - No value for parameter '"+Z.name+"' found!'");}});}K=F.substring(1)+"('"+q.sap.uid()+"')";V.__metadata={uri:z.sServiceUrl+'/'+K,created:{key:F.substring(1),success:S,error:E,headers:H,method:w,groupId:G,changeSetId:x,eTag:y,functionImport:true}};z._addEntity(V);D=z.getContext("/"+K);I(D);v=a._createUrlParamsArray(n);i=z._createRequestUrl(F,null,v,z.bUseBatch);R=z._createRequest(i,w,H,undefined,y);R.key=K;k=z.mRequests;if(G in z.mDeferredGroups){k=z.mDeferredRequests;}z._pushToRequestQueue(k,G,x,R,S,E,W,T);return R;},E);Q.contextCreated=function(){return L;};return Q;};r.prototype._createFunctionImportParameters=function(F,i,P){var j=q.extend(true,{},P);delete j.__metadata;delete j["$result"];var k=this.oMetadata._getFunctionImportMetadata(F,i);if(!k){return;}if(k.parameter!=null){q.each(k.parameter,function(I,n){if(j[n.name]){j[n.name]=a.formatValue(j[n.name],n.type);}});}return j;};r.prototype.read=function(P,i){var R,j,k,n,S,E,F,v,w,x,y,z,D,H,G,I,J,K,L=this;if(i){k=i.context;n=i.urlParameters;S=i.success;E=i.error;F=i.filters;v=i.sorters;I=i.groupId||i.batchGroupId;H=i.headers;}if(this.sRefreshGroupId){I=this.sRefreshGroupId;}D=a._createUrlParamsArray(n);H=this._getHeaders(H);G="GET";J=this._getETag(P,k);var Q={abort:function(){if(R){R._aborted=true;}}};function T(V){x=a.createSortParams(v);if(x){D.push(x);}var W=P;var X=P.indexOf("$count");if(X!==-1){W=P.substring(0,X-1);}z=L._normalizePath(W,k);y=L.oMetadata._getEntityTypeByPath(z);w=a.createFilterParams(F,L.oMetadata,y);if(w){D.push(w);}j=L._createRequestUrl(P,k,D,L.bUseBatch);R=L._createRequest(j,G,H,null,J);K=L.mRequests;if(I in L.mDeferredGroups){K=L.mDeferredRequests;}L._pushToRequestQueue(K,I,null,R,S,E,V,false);return R;}if(this.bUseBatch&&this.bIncludeInCurrentBatch){R=T(Q);return Q;}else{return this._processRequest(T,E);}};r.prototype.getServiceMetadata=function(){if(this.oMetadata&&this.oMetadata.isLoaded()){return this.oMetadata.getServiceMetadata();}};r.prototype.metadataLoaded=function(){var i=this.oMetadata.loaded();if(this.bLoadAnnotationsJoined){var j=function(){return i;};return this.pAnnotationsLoaded.then(j,j);}else{return i;}};r.prototype.annotationsLoaded=function(){return this.pAnnotationsLoaded;};r.prototype.isMetadataLoadingFailed=function(){return this.oMetadata.isFailed();};r.prototype.getServiceAnnotations=function(){var i=this.oAnnotations.getData();return q.isEmptyObject(i)?null:i;};r.prototype.onAnnotationsFailed=function(E){this.fireAnnotationsFailed(E.getParameters());};r.prototype.onAnnotationsLoaded=function(E){this.fireAnnotationsLoaded(E.getParameters());};r.prototype.addAnnotationUrl=function(v){var j=[].concat(v),k=[],n=[],E=[],w=this;q.each(j,function(i,x){var I=x.indexOf("$metadata");if(I>=0){if(I==0){x=w.sServiceUrl+'/'+x;}k.push(x);}else{n.push(x);}});return this.oMetadata._addUrl(k).then(function(P){return Promise.all(q.map(P,function(i){E=E.concat(i.entitySets);return w.oAnnotations.addSource({type:"xml",data:i["metadataString"]});}));}).then(function(){return w.oAnnotations.addSource(n);}).then(function(P){return{annotations:w.oAnnotations.getData(),entitySets:E};});};r.prototype.addAnnotationXML=function(x,S){return this.oAnnotations.addSource({type:"xml",data:x});};r.prototype.submitChanges=function(P){var R,G,j,S,E,k,v,n=false,w,x,y=this.bRefreshAfterChange,z,D=this;if(P){G=P.groupId||P.batchGroupId;S=P.success;E=P.error;if(P.merge!==undefined){w=P.merge?"MERGE":"PUT";}}if(G&&!this.mDeferredGroups[G]){q.sap.log.fatal(this+" submitChanges: \""+G+"\" is not a deferred group!");}x=q.sap.extend(true,{},D.mChangedEntities);this.oMetadata.loaded().then(function(){q.each(x,function(L,Q){j=D._resolveGroup(L);if(j.groupId===G||!G){R=D._processChange(L,Q,w||D.sDefaultUpdateMethod);R.key=L;z=Q.__metadata&&Q.__metadata.created?Q.__metadata.created:{};var k={abort:function(){R._aborted=true;}};if(j.groupId in D.mDeferredGroups){D._pushToRequestQueue(D.mDeferredRequests,j.groupId,j.changeSetId,R,z.success,z.error,k,y);}}});var F,H,I,J,K,i;for(F in D.mDeferredRequests){I=D.mDeferredRequests[F];for(H in I.changes){J=I.changes[H];for(i=J.length-1;i>=0;i--){K=J[i];if(K.bRefreshAfterChange===undefined){K.bRefreshAfterChange=y;}}}}v=D._processRequestQueue(D.mDeferredRequests,G,S,E);if(n){k.abort();}});k={abort:function(){if(v){if(q.isArray(v)){q.each(v,function(i,k){k.abort();});}else{v.abort();}}else{if(!n&&E){E(A);}n=true;}}};return k;};r.prototype._updateChangedEntities=function(i){var j=this,R;function k(n,v){q.each(v,function(K){var w=R+'/'+K;if(q.isPlainObject(v[K])&&q.isPlainObject(n[K])){k(n[K],v[K]);if(q.isEmptyObject(v[K])){delete v[K];}}else if(q.sap.equal(v[K],n[K])&&!j.isLaundering(w)){delete v[K];}});}q.each(i,function(K,D){if(K in j.mChangedEntities){var E=j._getObject('/'+K,null,true);var n=j._getObject('/'+K);q.sap.extend(true,E,D);R='/'+K;k(E,n);if(q.isEmptyObject(n)){delete j.mChangedEntities[K];j.abortInternalRequest(K,j._resolveGroup(K).groupId);}else{j.mChangedEntities[K]=n;n.__metadata={};q.extend(n.__metadata,E.__metadata);}}});};r.prototype.resetChanges=function(P){var j=this,k,E={},n,v;if(P){q.each(P,function(I,w){j.getEntityByPath(w,null,E);k=E.propertyPath.split("/");var K=E.key;n=j.mChangedEntities[K];for(var i=0;i<k.length-1;i++){if(n.hasOwnProperty(k[i])){n=n[k[i]];}else{n=undefined;}}if(n){delete n[k[k.length-1]];}if(j.mChangedEntities[K]){v=j.mChangedEntities[K].__metadata;delete j.mChangedEntities[K].__metadata;if(q.isEmptyObject(j.mChangedEntities[K])||!E.propertyPath){j.oMetadata.loaded().then(function(){j.abortInternalRequest(K,j._resolveGroup(K).groupId);});delete j.mChangedEntities[K];}else{j.mChangedEntities[K].__metadata=v;}}else{q.sap.log.warning(j+" - resetChanges: "+w+" is not changed");}});}else{q.each(this.mChangedEntities,function(K,i){j.oMetadata.loaded().then(function(){j.abortInternalRequest(K,j._resolveGroup(K).groupId);});delete j.mChangedEntities[K];});}this.checkUpdate(true);};r.prototype.setProperty=function(P,v,j,k){var n,w,R,x,y,E,z,D,K,G,F,H,I={},J={},L,Q,S,T=false,V=this,W;function X(Y,Z){q.each(Z,function(K){if(q.isPlainObject(Z[K])&&q.isPlainObject(Y[K])){X(Y[K],Z[K]);if(q.isEmptyObject(Z[K])){delete Z[K];}}else if(q.sap.equal(Z[K],Y[K])){delete Z[K];}});}z=this.resolve(P,j,true);E=this.getEntityByPath(z,null,J);if(!E){return false;}w=z.substring(z.lastIndexOf("/")+1);K=J.key;y=this._getObject('/'+K,null,true);n=this._getObject(P,j,true);if(!this.mChangedEntities[K]){H=E.__metadata;E={};E.__metadata=q.extend({},H);this.mChangedEntities[K]=E;}Q=this.mChangedEntities[K];D=J.propertyPath.split("/");for(var i=0;i<D.length-1;i++){if(!Q.hasOwnProperty(D[i])){Q[D[i]]={};}Q=Q[D[i]];}T=y.__metadata.created&&y.__metadata.created.functionImport;Q[w]=v;if(q.sap.equal(v,n)&&!this.isLaundering('/'+K)&&!T){H=this.mChangedEntities[K].__metadata;W=H&&H.created;delete this.mChangedEntities[K].__metadata;if(!W){X(y,this.mChangedEntities[K]);}if(q.isEmptyObject(this.mChangedEntities[K])){delete this.mChangedEntities[K];I[K]=true;this.checkUpdate(false,k,I);V.oMetadata.loaded().then(function(){V.abortInternalRequest(K,V._resolveGroup(K).groupId);});return true;}this.mChangedEntities[K].__metadata=H;}G=this._resolveGroup(K);R=this.mRequests;if(G.groupId in this.mDeferredGroups){R=this.mDeferredRequests;x=this._processChange(K,{__metadata:E.__metadata});}else{x=this._processChange(K,this._getObject('/'+K));}x.key=K;L=Q.__metadata&&Q.__metadata.created?Q.__metadata.created:{};S=this._getRefreshAfterChange(undefined,G.groupId);this.oMetadata.loaded().then(function(){F={abort:function(){x._aborted=true;}};V._pushToRequestQueue(R,G.groupId,G.changeSetId,x,L.success,L.error,F,S);V._processRequestQueueAsync(V.mRequests);});I[K]=true;this.checkUpdate(false,k,I);return true;};r.prototype._isHeaderPrivate=function(H){switch(H.toLowerCase()){case"accept":case"accept-language":case"maxdataserviceversion":case"dataserviceversion":return true;case"x-csrf-token":return this.bTokenHandling;case"sap-contextid-accept":case"sap-contextid":return!this.bDisableSoftStateHeader;default:return false;}return false;};r.prototype.setHeaders=function(H){var i={},j=this;this.mCustomHeaders={};if(H){q.each(H,function(k,n){if(j._isHeaderPrivate(k)){q.sap.log.warning(this+" - modifying private header: '"+k+"' not allowed!");}else{i[k]=n;}});this.mCustomHeaders=i;}if(this.oAnnotations){this.oAnnotations.setHeaders(this.mCustomHeaders);}};r.prototype._getHeaders=function(H){var i={},j=this;if(H){q.each(H,function(k,n){if(j._isHeaderPrivate(k)){q.sap.log.warning(this+" - modifying private header: '"+k+"' not allowed!");}else{i[k]=n;}});}return q.extend({},this.mCustomHeaders,i,this.oHeaders);};r.prototype.getHeaders=function(){return q.extend({},this.mCustomHeaders,this.oHeaders);};r.prototype._getHeader=function(H,i){var j;for(j in i){if(j.toLowerCase()===H.toLowerCase()){return i[j];}}return null;};r.prototype.hasPendingChanges=function(){return!q.isEmptyObject(this.mChangedEntities);};r.prototype.hasPendingRequests=function(){return this.aPendingRequestHandles.length>0;};r.prototype.getPendingChanges=function(){return q.sap.extend(true,{},this.mChangedEntities);};r.prototype.updateBindings=function(F){this.checkUpdate(F);};r.prototype.setTokenHandlingEnabled=function(T){this.bTokenHandling=T;};r.prototype.setUseBatch=function(i){this.bUseBatch=i;};r.prototype.formatValue=function(v,T){return a.formatValue(v,T);};r.prototype.deleteCreatedEntry=function(i){var j=this,k,G;if(i){var k=i.getPath().substr(1);G=this._resolveGroup(k).groupId;j.oMetadata.loaded().then(function(){j.abortInternalRequest(k,G);});j._removeEntity(k);}};r.prototype.createEntry=function(P,j){var S,E,R,k,n,v,K,w,G,x,y,z,H,D,F,I={},J,L="POST",Q=this;if(j){F=j.properties;G=j.groupId||j.batchGroupId;x=j.changeSetId;v=j.context;S=j.success;E=j.error;J=j.created;n=j.eTag;H=j.headers;z=j.urlParameters;y=j.refreshAfterChange;}y=this._getRefreshAfterChange(y,G);G=G?G:this.sDefaultChangeGroup;w=a._createUrlParamsArray(z);H=this._getHeaders(H);var T={abort:function(){if(R){R._aborted=true;}}};function V(){var W;if(!q.sap.startsWith(P,"/")){P="/"+P;}var X=Q.oMetadata._getEntityTypeByPath(P);if(!X){return undefined;}if(typeof F==="object"&&!q.isArray(F)){I=F;}else{for(var i=0;i<X.property.length;i++){var Y=X.property[i];var Z=q.inArray(Y.name,F)>-1;if(!F||Z){I[Y.name]=Q._createPropertyValue(Y.type);if(Z){F.splice(F.indexOf(Y.name),1);}}}if(F){}}var $=Q.oMetadata._getEntitySetByType(X);K=$.name+"('"+q.sap.uid()+"')";I.__metadata={type:""+X.entityType,uri:Q.sServiceUrl+'/'+K,created:{key:P.substring(1),success:S,error:E,headers:H,urlParameters:z,groupId:G,changeSetId:x,eTag:n}};Q._addEntity(q.sap.extend(true,{},I));Q.mChangedEntities[K]=I;k=Q._createRequestUrl(P,v,w,Q.bUseBatch);R=Q._createRequest(k,L,H,I,n);W=Q.getContext("/"+K);W.bCreated=true;R.key=K;D=Q.mRequests;if(G in Q.mDeferredGroups){D=Q.mDeferredRequests;}Q.oMetadata.loaded().then(function(){Q._pushToRequestQueue(D,G,x,R,S,E,T,y);Q._processRequestQueueAsync(Q.mRequests);});return W;}if(J){this.oMetadata.loaded().then(function(){J(V());});}else if(this.oMetadata.isLoaded()){return V();}else{q.sap.log.error("Tried to use createEntry without created-callback, before metadata is available!");}};r.prototype._isCreatedEntity=function(E){return!!(E&&E.__metadata&&E.__metadata.created);};r.prototype._createPropertyValue=function(T){var j=this.oMetadata._splitName(T);var n=j[1];var k=j[0];if(n.toUpperCase()!=='EDM'){var v={};var w=this.oMetadata._getObjectMetadata("complexType",k,n);for(var i=0;i<w.property.length;i++){var P=w.property[i];v[P.name]=this._createPropertyValue(P.type);}return v;}else{return this._getDefaultPropertyValue(k,n);}};r.prototype._getDefaultPropertyValue=function(T,n){return undefined;};r.prototype._normalizePath=function(P,i){if(P&&P.indexOf('?')!==-1){P=P.substr(0,P.indexOf('?'));}if(!i&&!q.sap.startsWith(P,"/")){q.sap.log.fatal(this+" path "+P+" must be absolute if no Context is set");}return this.resolve(P,i);};r.prototype.getRefreshAfterChange=function(){return this.bRefreshAfterChange;};r.prototype.setRefreshAfterChange=function(R){this.bRefreshAfterChange=R;};r.prototype.isList=function(P,i){P=this.resolve(P,i);return P&&P.substr(P.lastIndexOf("/")).indexOf("(")===-1;};r.prototype.isMetaModelPath=function(P){return P.indexOf("##")==0||P.indexOf("/##")>-1;};r.prototype._request=function(R,S,E,H,i,j){var k;if(this.bDestroyed){return{abort:function(){}};}var n=this;function w(v){return function(){var I=q.inArray(k,n.aPendingRequestHandles);if(I>-1){n.aPendingRequestHandles.splice(I,1);}if(!(k&&k.bSuppressErrorHandlerCall)){v.apply(this,arguments);}};}k=p.request(R,w(S||p.defaultSuccess),w(E||p.defaultError),H,i,j);if(R.async!==false){this.aPendingRequestHandles.push(k);}return k;};r.prototype.destroy=function(){this.bDestroyed=true;M.prototype.destroy.apply(this,arguments);if(this.aPendingRequestHandles){for(var i=this.aPendingRequestHandles.length-1;i>=0;i--){var R=this.aPendingRequestHandles[i];if(R&&R.abort){R.bSuppressErrorHandlerCall=true;R.abort();}}delete this.aPendingRequestHandles;}if(this.sMetadataLoadEvent){q.sap.clearDelayedCall(this.sMetadataLoadEvent);}if(this.oMetadataFailedEvent){q.sap.clearDelayedCall(this.oMetadataFailedEvent);}if(this.oMetadata){this.oMetadata.detachFailed(this.onMetadataFailed);if(!this.oMetadata.isLoaded()&&!this.oMetadata.hasListeners("loaded")){this.oMetadata.destroy();delete this.oServiceData.oMetadata;}delete this.oMetadata;}if(this.oMetaModel){this.oMetaModel.destroy();delete this.oMetaModel;}if(this.oAnnotations){this.oAnnotations.detachSomeLoaded(this.onAnnotationsLoaded);this.oAnnotations.detachAllFailed(this.onAnnotationsFailed);this.oAnnotations.destroy();delete this.oAnnotations;}};r.prototype.setDeferredBatchGroups=function(G){this.setDeferredGroups(G);};r.prototype.setDeferredGroups=function(G){var i=this;this.mDeferredGroups={};q.each(G,function(I,j){i.mDeferredGroups[j]=j;});};r.prototype.getDeferredBatchGroups=function(){return this.getDeferredGroups();};r.prototype.getDeferredGroups=function(){var G=[],i=0;q.each(this.mDeferredGroups,function(k,j){G[i]=j;i++;});return G;};r.prototype.setChangeBatchGroups=function(G){q.each(G,function(E,i){i.groupId=i.batchGroupId;});this.setChangeGroups(G);};r.prototype.setChangeGroups=function(G){this.mChangeGroups=G;};r.prototype.getChangeBatchGroups=function(){return this.getChangeGroups();};r.prototype.getChangeGroups=function(){return this.mChangeGroups;};r.prototype.setMessageParser=function(P){if(!(P instanceof m)){q.sap.log.error("Given MessageParser is not of type sap.ui.core.message.MessageParser");return this;}P.setProcessor(this);this.oMessageParser=P;return this;};r.prototype._parseResponse=function(R,i,G,j){try{if(!this.oMessageParser){this.oMessageParser=new o(this.sServiceUrl,this.oMetadata);this.oMessageParser.setProcessor(this);}return this.oMessageParser.parse(R,i,G,j);}catch(k){q.sap.log.error("Error parsing OData messages: "+k);}};r.prototype.callAfterUpdate=function(F){this.aCallAfterUpdate.push(F);};r.prototype.getMetaModel=function(){var i=this;if(!this.oMetaModel){this.oMetaModel=new l(this.oMetadata,this.oAnnotations,{addAnnotationUrl:this.addAnnotationUrl.bind(this),annotationsLoadedPromise:this.pAnnotationsLoaded});this.oMetaModel.loaded().then(function(){i.bMetaModelLoaded=true;i.checkUpdate(false,false,null,true);},function(E){var j=E.message,D;if(!j&&E.xmlDoc&&E.xmlDoc.parseError){j=E.xmlDoc.parseError.reason;D=E.xmlDoc.parseError.srcText;}q.sap.log.error("error in ODataMetaModel.loaded(): "+j,D,"sap.ui.model.odata.v2.ODataModel");});}return this.oMetaModel;};r.prototype.getOriginalProperty=function(P,i){return this._getObject(P,i,true);};r.prototype.getEntityByPath=function(P,i,E){var R=M.prototype.resolve.call(this,P,i);if(!R){return null;}var j=R.split("/"),k=null,n=[];while(j.length>0){var v=j.join("/"),w=this._getObject(v);if(q.isPlainObject(w)){var K=this._getKey(w);if(K){k=w;break;}}n.unshift(j.pop());}if(k){E.propertyPath=n.join("/");E.key=K;return k;}return null;};r.prototype.resolve=function(P,i,j){var R=M.prototype.resolve.call(this,P,i);if(j){var E={},k=this.getEntityByPath(P,i,E);if(k){if(E.propertyPath){return"/"+E.key+"/"+E.propertyPath;}else{return"/"+E.key;}}else{return undefined;}}return R;};r.prototype.isLaundering=function(P,i){var R=this.resolve(P,i);return(R in this.mLaunderingState)&&this.mLaunderingState[R]>0;};r.prototype.increaseLaundering=function(P,i){if(!i){return;}for(var n in i){if(n==="__metadata"){continue;}var j=i[n];if(q.isPlainObject(j)){this.increaseLaundering(P+"/"+n,j);}else{var T=P+"/"+n;if(!(T in this.mLaunderingState)){this.mLaunderingState[T]=0;}this.mLaunderingState[T]++;}}if(!(P in this.mLaunderingState)){this.mLaunderingState[P]=0;}this.mLaunderingState[P]++;};r.prototype.decreaseLaundering=function(P,i){if(!i){return;}for(var n in i){if(n==="__metadata"){continue;}var j=i[n],T=P+"/"+n;if(q.isPlainObject(j)){this.decreaseLaundering(T,j);}else{if(T in this.mLaunderingState){this.mLaunderingState[T]--;if(this.mLaunderingState[T]===0){delete this.mLaunderingState[T];}}}}this.mLaunderingState[P]--;if(this.mLaunderingState[P]===0){delete this.mLaunderingState[P];}};r.prototype._getRefreshAfterChange=function(R,G){if(R===undefined&&!(G in this.mDeferredGroups)){return this.bRefreshAfterChange;}return R;};return r;});
